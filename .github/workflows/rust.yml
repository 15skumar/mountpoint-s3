name: Rust Tests

on:
  push:
  pull_request:
    branches: [ "main" ]

env:
  RUSTFLAGS: -Dwarnings
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  S3_BUCKET_NAME: s3-file-connector-github-test-bucket
  S3_BUCKET_TEST_PREFIX: github-actions-tmp/run-${{ github.run_id }}/attempt-${{ github.run_attempt }}

jobs:
  test:
    name: Tests
    runs-on: ubuntu-22.04

    permissions:
      id-token: write
      contents: read

    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: arn:aws:iam::360461222476:role/GitHub-Actions-Role
        aws-region: us-east-1
    # Lifecycle on the bucket cleans these objects up for us
    - name: Put test object
      run: |
        TMP=$(mktemp)
        echo "Test object to check bucket exists" > $TMP
        aws s3api put-object --bucket $S3_BUCKET_NAME --key $S3_BUCKET_TEST_PREFIX/test --body $TMP
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: true
    - name: Install fuse
      run: sudo apt-get install fuse libfuse2 libfuse-dev
    - name: Configure fuse
      run: echo 'user_allow_other' | sudo tee -a /etc/fuse.conf
    - name: Check all targets
      run: cargo check --all-targets
    - name: Run tests
      run: cargo test --features fuse_tests

  rustfmt:
    name: rustfmt
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Install rustfmt
        run: rustup component add rustfmt
      - name: Check s3-client
        run: cargo fmt --manifest-path s3-client/Cargo.toml -- --check
      - name: Check s3-file-connector
        run: cargo fmt --manifest-path s3-file-connector/Cargo.toml -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: true
      - name: Install fuse
        run: sudo apt-get install fuse libfuse2 libfuse-dev
      - name: Run Clippy
        run: cargo clippy -p s3-client -p aws-s3-fuse --no-deps --all-targets -- -D clippy::all
